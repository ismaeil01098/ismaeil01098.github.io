<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€“ Ù…Ù†ØµØ© Ø§Ù„Ø¹Ù„ÙˆÙ…</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: #f4f4f4;
      color: #333;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .password-box {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      width: 90%;
      max-width: 350px;
      text-align: center;
    }
    .password-box input {
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.8rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .password-box button {
      margin-top: 1rem;
      background: #b6a564;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.7rem 1.2rem;
      cursor: pointer;
      font-size: 1rem;
    }
    .password-box .error {
      color: red;
      margin-top: 0.8rem;
    }

    .topnav {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      background: #24221e;
      padding: 0.7rem 0;
      flex-wrap: wrap;
    }
    .topnav div {
      color: white;
      background: #b6a564;
      padding: 0.5rem 1.2rem;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 0.95rem;
    }
    .topnav div.active {
      background: #3ab54a;
    }

    .main {
      padding: 1rem;
      max-width: 1000px;
      margin: auto;
    }

    section {
      display: none;
      margin-top: 1.5rem;
    }
    section.active {
      display: block;
    }

    h2 {
      margin-bottom: 1rem;
      color: #444;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.4rem;
      font-weight: bold;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.6rem;
      text-align: center;
    }

    th {
      background: #b6a564;
      color: white;
    }

    .loader {
      text-align: center;
      margin-top: 1rem;
      color: #999;
    }
  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± -->
<div id="overlay" class="overlay">
  <div class="password-box">
    <h3>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    <input type="password" id="admin-pass" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button onclick="checkPassword()">Ø¯Ø®ÙˆÙ„</button>
    <div id="pass-error" class="error"></div>
  </div>
</div>

<!-- Ù…Ø­ØªÙˆÙ‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
<div id="dashboard" style="display:none;">
  <div class="topnav">
    <div id="tab-stu" class="active" onclick="showSection('students')">ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
    <div id="tab-con" onclick="showSection('content')">ğŸ“ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</div>
    <div id="tab-ann" onclick="showSection('announce')">ğŸ”” Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
    <div id="tab-stat" onclick="showSection('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
  </div>

  <div class="main">
    <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ ÙƒÙ„ Ù‚Ø³Ù… Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ -->
  </div>
</div>

</body>
</html>
<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  const firebaseConfig = {
    apiKey: "AIzaSyDEvdGB2dHbB9k0mvAa14VFaKvjSfooB20",
    authDomain: "manssat-science.firebaseapp.com",
    databaseURL: "https://manssat-science-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "manssat-science",
    storageBucket: "manssat-science.appspot.com",
    messagingSenderId: "22539678455",
    appId: "1:22539678455:web:bd8cdc9ecd950a2b53d9f2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø«Ø§Ø¨ØªØ©
  const ADMIN_PASSWORD = "islamemad01122104596#";

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
  function checkPassword() {
    const input = document.getElementById("admin-pass").value.trim();
    const errorDiv = document.getElementById("pass-error");

    if (input === ADMIN_PASSWORD) {
      // Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙÙŠ localStorage
      localStorage.setItem("adminAccess", "granted");
      document.getElementById("overlay").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      showSection("students");
    } else {
      errorDiv.innerText = "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    }
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ø­ÙÙˆØ¸Ø©
  window.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem("adminAccess");
    if (saved === "granted") {
      document.getElementById("overlay").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      showSection("students");
    }
  });

  // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
  function showSection(id) {
    ["students", "content", "announce", "stats"].forEach(section => {
      const secEl = document.getElementById(section);
      const tabEl = document.getElementById("tab-" + section.slice(0, 3));
      if (secEl && tabEl) {
        secEl.classList.toggle("active", section === id);
        tabEl.classList.toggle("active", section === id);
      }
    });
  }
</script>
<script>
  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
  function loadStudents() {
    const loader = document.getElementById("loader-stu");
    const tbl = document.getElementById("tbl-stu");
    const body = tbl.querySelector("tbody");
    loader.style.display = "block";
    tbl.style.display = "none";
    body.innerHTML = "";

    db.ref("users/students").once("value").then(snapshot => {
      const data = snapshot.val() || {};
      let total = 0;
      let active = 0;

      Object.entries(data).forEach(([phone, user]) => {
        total++;
        if (user["Ø§Ø´ØªØ±Ø§Ùƒ_Ù…ÙØ¹Ù„"]) active++;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${phone}</td>
          <td>${user["Ø§Ù„Ø§Ø³Ù…"] || "-"}</td>
          <td>${user["Ø§Ù„Ù…Ø±Ø­Ù„Ø©"] || "-"}</td>
          <td>${user["Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©"] || "-"}</td>
          <td>${user["Ø§Ø´ØªØ±Ø§Ùƒ_Ù…ÙØ¹Ù„"] ? "âœ…" : "âŒ"}</td>
          <td>${user["Ù…Ø³Ø¬Ù„_ÙÙŠ"] ? new Date(user["Ù…Ø³Ø¬Ù„_ÙÙŠ"]).toLocaleDateString('ar-EG') : "-"}</td>
          <td>
            <button class="action ${user["Ø§Ø´ØªØ±Ø§Ùƒ_Ù…ÙØ¹Ù„"] ? "inactive-btn" : "active-btn"}"
              onclick="toggleActivation('${phone}', ${user["Ø§Ø´ØªØ±Ø§Ùƒ_Ù…ÙØ¹Ù„"] ? "false" : "true"})">
              ${user["Ø§Ø´ØªØ±Ø§Ùƒ_Ù…ÙØ¹Ù„"] ? "Ø¥Ù„ØºØ§Ø¡" : "ØªÙØ¹ÙŠÙ„"}
            </button>
            <button class="action delete-btn" onclick="deleteStudent('${phone}')">Ø­Ø°Ù</button>
          </td>
        `;
        body.appendChild(row);
      });

      document.getElementById("cntAll").innerText = total;
      document.getElementById("cntActive").innerText = active;
    }).finally(() => {
      loader.style.display = "none";
      tbl.style.display = "table";
    });
  }

  // ØªÙØ¹ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨
  function toggleActivation(phone, status) {
    db.ref(`users/students/${phone}/Ø§Ø´ØªØ±Ø§Ùƒ_Ù…ÙØ¹Ù„`).set(status).then(loadStudents);
  }

  // Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨
  function deleteStudent(phone) {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) {
      db.ref(`users/students/${phone}`).remove().then(loadStudents);
    }
  }

  // Ø¨Ø­Ø« Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
  function filterStudents() {
    const input = document.getElementById("student-search").value.trim().toLowerCase();
    const rows = document.querySelectorAll("#tbl-stu tbody tr");
    rows.forEach(row => {
      const phone = row.cells[0].innerText.toLowerCase();
      const name = row.cells[1].innerText.toLowerCase();
      row.style.display = (phone.includes(input) || name.includes(input)) ? "" : "none";
    });
  }
</script>
<script>
  // Ù†Ø´Ø± Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯
  function submitContent() {
    const stage = document.getElementById("content-stage").value;
    const type = document.getElementById("content-type").value;
    const title = document.getElementById("content-title").value.trim();
    const url = document.getElementById("content-url").value.trim();
    const duration = document.getElementById("content-duration").value.trim();

    if (!stage || !type || !title || !url) {
      alert("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");
      return;
    }

    const id = Date.now(); // ID ÙØ±ÙŠØ¯ Ø¨Ø§Ù„ÙˆÙ‚Øª
    db.ref(`content/${stage}/${id}`).set({
      type,
      title,
      url,
      duration: duration || "-",
      createdAt: new Date().toISOString()
    }).then(() => {
      loadContent();
      document.getElementById("content-title").value = "";
      document.getElementById("content-url").value = "";
      document.getElementById("content-duration").value = "";
    });
  }

  // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
  function loadContent() {
    const loader = document.getElementById("loader-con");
    const tbl = document.getElementById("tbl-con");
    const body = tbl.querySelector("tbody");

    loader.style.display = "block";
    tbl.style.display = "none";
    body.innerHTML = "";

    db.ref("content").once("value").then(snapshot => {
      snapshot.forEach(stageSnap => {
        const stage = stageSnap.key;
        stageSnap.forEach(itemSnap => {
          const item = itemSnap.val();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${itemSnap.key}</td>
            <td>${stage}</td>
            <td>${item.type}</td>
            <td>${item.title}</td>
            <td><a href="${item.url}" target="_blank">Ø±Ø§Ø¨Ø·</a></td>
            <td>${item.duration}</td>
            <td>
              <button class="action delete-btn"
                onclick="deleteContent('${stage}', '${itemSnap.key}')">Ø­Ø°Ù</button>
            </td>
          `;
          body.appendChild(row);
        });
      });
    }).finally(() => {
      loader.style.display = "none";
      tbl.style.display = "table";
    });
  }

  // Ø­Ø°Ù Ù…Ø­ØªÙˆÙ‰
  function deleteContent(stage, id) {
    if (confirm("ğŸ—‘ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ")) {
      db.ref(`content/${stage}/${id}`).remove().then(loadContent);
    }
  }
</script>
<script>
  // Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†
  function addAnnouncement() {
    const stage = document.getElementById("ann-stage").value;
    const text = document.getElementById("ann-text").value.trim();

    if (!stage || !text) {
      alert("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.");
      return;
    }

    db.ref(`settings/announcements/${stage}`).set({
      text: text,
      updatedAt: new Date().toISOString()
    }).then(() => {
      loadAnnouncements();
      document.getElementById("ann-text").value = "";
    });
  }

  // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
  function loadAnnouncements() {
    const loader = document.getElementById("loader-ann");
    const tbl = document.getElementById("tbl-ann");
    const body = tbl.querySelector("tbody");

    loader.style.display = "block";
    tbl.style.display = "none";
    body.innerHTML = "";

    db.ref("settings/announcements").once("value").then(snapshot => {
      snapshot.forEach(child => {
        const value = child.val();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${child.key}</td>
          <td>${value.text}</td>
          <td>
            <button class="action delete-btn"
              onclick="deleteAnnouncement('${child.key}')">Ø­Ø°Ù</button>
          </td>
        `;
        body.appendChild(row);
      });
    }).finally(() => {
      loader.style.display = "none";
      tbl.style.display = "table";
    });
  }

  // Ø­Ø°Ù Ø¥Ø¹Ù„Ø§Ù†
  function deleteAnnouncement(stage) {
    if (confirm("ğŸ—‘ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ")) {
      db.ref(`settings/announcements/${stage}`).remove().then(loadAnnouncements);
    }
  }
</script>
<script>
  let chart;

  function loadStats() {
    db.ref("users/students").once("value").then(snapshot => {
      const counts = {
        grade4: 0,
        grade5: 0,
        grade6: 0,
        prep1: 0,
        prep2: 0,
        prep3: 0
      };

      let total = 0;
      let active = 0;

      snapshot.forEach(child => {
        const data = child.val();
        const stage = data["Ø§Ù„Ù…Ø±Ø­Ù„Ø©"];
        const isActive = data["Ø§Ø´ØªØ±Ø§Ùƒ_Ù…ÙØ¹Ù„"];

        total++;
        if (isActive) active++;

        if (stage && counts.hasOwnProperty(stage)) {
          counts[stage]++;
        }
      });

      // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
      document.getElementById("cntAll").innerText = total;
      document.getElementById("cntActive").innerText = active;

      // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
      const ctx = document.getElementById("chartStages").getContext("2d");
      if (chart) chart.destroy(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Ø±Ø§Ø¨Ø¹", "Ø®Ø§Ù…Ø³", "Ø³Ø§Ø¯Ø³", "Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ"],
          datasets: [{
            label: "Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨",
            data: Object.values(counts),
            backgroundColor: "#3ab54a"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©" }
          }
        }
      });
    });
  }
</script>
<script>
  // ØªØ´ØºÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
  showSection('students');

  // Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
  function filterStudents() {
    const input = document.getElementById("student-search").value.trim().toLowerCase();
    const rows = document.querySelectorAll("#tbl-stu tbody tr");
    rows.forEach(row => {
      const phone = row.cells[0].innerText.toLowerCase();
      const name = row.cells[1].innerText.toLowerCase();
      row.style.display = (phone.includes(input) || name.includes(input)) ? "" : "none";
    });
  }
</script>

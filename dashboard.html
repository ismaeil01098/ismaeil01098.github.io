<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€“ Ù…Ù†ØµØ© Ø§Ù„Ø¹Ù„ÙˆÙ…</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { margin:0; font-family:'Tajawal',sans-serif; background:#f4f4f4; color:#333; }
    .overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.85); display:flex;
      align-items:center; justify-content:center; z-index:1000;
    }
    .password-box {
      background:#fff; padding:1.5rem; border-radius:10px;
      width:90%; max-width:320px; text-align:center;
    }
    .password-box input {
      width:100%; padding:0.7rem; margin-top:0.5rem;
      border:1px solid #ccc; border-radius:5px;
      font-size:1rem;
    }
    .password-box button {
      margin-top:1rem; padding:0.7rem 1rem;
      background:#b6a564; color:#fff; border:none;
      border-radius:5px; font-size:1rem; cursor:pointer;
    }
    .password-box .error { color:red; margin-top:0.6rem; }
    .topnav {
      display:flex; flex-wrap:wrap; justify-content:center;
      gap:0.6rem; background:#24221e; color:#fff;
      padding:0.7rem 0; font-size:0.95rem;
    }
    .topnav div {
      cursor:pointer; padding:0.4rem 1.2rem;
      border-radius:20px; background:#b6a564; color:#fff;
      transition:0.3s;
    }
    .topnav div.active { background:#3ab54a; }
    .main { padding:1rem; max-width:1000px; margin:auto; }
    section { display:none; margin-top:1.5rem; }
    section.active { display:block; }
    table { width:100%; border-collapse:collapse; font-size:0.9rem; margin-top:0.5rem; }
    th, td { padding:0.5rem; border:1px solid #ccc; text-align:center; }
    th { background:#b6a564; color:#fff; }
    .action { padding:0.4rem 0.7rem; font-size:0.8rem;
      border:none; border-radius:4px; cursor:pointer; margin:0 0.2rem;}
    .active-btn { background:#3ab54a; color:#fff; }
    .inactive-btn { background:#ec5353; color:#fff; }
    .delete-btn { background:#777; color:#fff; }
    .form-group { margin-bottom:1rem; }
    .form-group label { display:block; margin-bottom:0.4rem; }
    .form-group input, .form-group textarea, .form-group select {
      width:100%; padding:0.5rem; border-radius:5px; border:1px solid #ccc;
    }
    .loader { text-align:center; margin:1rem 0; color:#888; }
    canvas { max-width:600px; margin:1rem auto; display:block; }
  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± -->
<div id="overlay" class="overlay">
  <div class="password-box">
    <h3>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    <input type="password" id="admin-pass" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"/>
    <button onclick="checkPassword()">Ø¯Ø®ÙˆÙ„</button>
    <div id="pass-error" class="error"></div>
  </div>
</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
<div id="dashboard" style="display:none;">
  <div class="topnav">
<div id="tab-stu" class="active" onclick="showSection('students')">ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
<div id="tab-con" onclick="showSection('content')">ğŸ“ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</div>
<div id="tab-ann" onclick="showSection('announce')">ğŸ”” Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
<div id="tab-stat" onclick="showSection('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
  </div>
  <div class="main">

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ -->
<section id="students" class="active">
  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>

  <div class="form-group">
    <input type="text" id="student-search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ" oninput="filterStudents()" />
  </div>
  <div id="loader-stu" class="loader">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
  <table id="tbl-stu" style="display:none;">
        <thead><tr>
          <th>Ù‡Ø§ØªÙ</th><th>Ø§Ø³Ù…</th><th>Ù…Ø±Ø­Ù„Ø©</th><th>Ù…Ø­Ø§ÙØ¸Ø©</th>
          <th>Ù…ÙØ¹Ù„ØŸ</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
    <section id="content">
      <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰</h2>
      <div class="form-group">
        <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
        <select id="content-stage">
          <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
          <option value="grade4">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
          <option value="grade5">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option>
          <option value="grade6">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
          <option value="prep1">Ø§Ù„Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
          <option value="prep2">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
          <option value="prep3">Ø§Ù„Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
        <select id="content-type">
          <option value="video">ÙÙŠØ¯ÙŠÙˆ</option>
          <option value="file">Ù…Ù„Ù</option>
          <option value="quiz">Ø§Ø®ØªØ¨Ø§Ø±</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
        <input type="text" id="content-title"/>
      </div>
      <div class="form-group">
        <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
        <input type="text" id="content-url"/>
      </div>
      <div class="form-group">
        <label>Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="text" id="content-duration" placeholder="Ù…Ø«Ø§Ù„: 10:30"/>
      </div>
      <button class="action active-btn" onclick="submitContent()">â• Ù†Ø´Ø±</button>
      <div id="loader-con" class="loader">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰â€¦</div>
      <table id="tbl-con" style="display:none;">
        <thead><tr><th>ID</th><th>Ù…Ø±Ø­Ù„Ø©</th><th>Ù†ÙˆØ¹</th><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ø±Ø§Ø¨Ø·</th><th>Ù…Ø¯Ø©</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
    <section id="announce">
      <h2>Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</h2>
      <div class="form-group">
        <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>
        <select id="ann-stage">
          <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
          <option value="grade4">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
          <option value="grade5">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option>
          <option value="grade6">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
          <option value="prep1">Ø§Ù„Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
          <option value="prep2">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
          <option value="prep3">Ø§Ù„Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
        <textarea id="ann-text" rows="3"></textarea>
      </div>
      <button class="action active-btn" onclick="addAnnouncement()">â• Ù†Ø´Ø±</button>
      <div id="loader-ann" class="loader">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øªâ€¦</div>
      <table id="tbl-ann" style="display:none;">
        <thead><tr><th>Ù…Ø±Ø­Ù„Ø©</th><th>Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <section id="stats">
      <h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØµØ©</h2>
      <canvas id="chartStages"></canvas>
      <p>ğŸ“Œ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="cntAll">0</span></p>
      <p>âœ… Ù…Ø´ØªØ±ÙƒÙˆÙ† Ù…ÙØ¹Ù„ÙˆÙ†: <span id="cntActive">0</span></p>
    </section>

  </div>
</div>

<script>
  // ==== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ====
  const firebaseConfig = {
    apiKey: "AIzaSyAQ71OtMZ3jvoSgziKsyxB1XUKhz9WFRSA",
    authDomain: "monasat-oloum.firebaseapp.com",
    databaseURL: "https://monasat-oloum-default-rtdb.firebaseio.com",
    projectId: "monasat-oloum",
    storageBucket: "monasat-oloum.appspot.com",
    messagingSenderId: "500281750476",
    appId: "1:500281750476:web:67aa4bf47d5744dc5f6369"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ==== Ø¯Ø®ÙˆÙ„ Ø¨Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø«Ø§Ø¨Øª ====
  const SECRET = "islamemad01122104596";
  function checkPassword() {
    const pass = document.getElementById('admin-pass').value.trim();
    if (pass === SECRET) {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      showSection('students');
      loadStudents(); loadStats();
    } else {
      document.getElementById('pass-error').innerText = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
    }
  }

  // ==== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ====
  function showSection(id) {
    ['students','content','announce','stats'].forEach(sec => {
      document.getElementById(sec).classList.toggle('active', sec === id);
      document.getElementById('tab-'+sec.slice(0,3)).classList.toggle('active', sec === id);
    });
  }

  // ==== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ====
  function loadStudents() {
    document.getElementById('loader-stu').style.display = 'block';
    const tbl = document.getElementById('tbl-stu');
    const body = tbl.querySelector('tbody');
    body.innerHTML = '';
    db.ref('users/students').once('value').then(snap => {
      const data = snap.val() || {};
      let total=0, active=0;
      Object.entries(data).forEach(([ph, st]) => {
        total++; if (st.subscription?.active) active++;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${ph}</td>
          <td>${st.name||'-'}</td>
          <td>${st.stage||'-'}</td>
          <td>${st.governorate||'-'}</td>
          <td>${st.subscription?.active?'âœ…':'âŒ'}</td>
          <td>${st.registeredAt?new Date(st.registeredAt).toLocaleDateString('ar-EG'):'-'}</td>
          <td>
            <button class="action ${st.subscription?.active?'inactive-btn':'active-btn'}"
              onclick="db.ref('users/students/${ph}/subscription/active').set(${!st.subscription?.active}).then(loadStudents)">
              ${st.subscription?.active?'Ø¥Ù„ØºØ§Ø¡':'ØªÙØ¹ÙŠÙ„'}
            </button>
            <button class="action delete-btn"
              onclick="if(confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) db.ref('users/students/${ph}').remove().then(loadStudents)">
              Ø­Ø°Ù
            </button>
          </td>`;
        body.appendChild(row);
      });
      document.getElementById('cntAll').innerText = total;
      document.getElementById('cntActive').innerText = active;
    }).finally(() => {
      document.getElementById('loader-stu').style.display = 'none';
      tbl.style.display = 'table';
    });
  }

  // ==== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ====
  function submitContent() {
    const s = document.getElementById('content-stage').value;
    const t = document.getElementById('content-type').value;
    const ti= document.getElementById('content-title').value.trim();
    const u = document.getElementById('content-url').value.trim();
    const d = document.getElementById('content-duration').value.trim();
    if(!s||!t||!ti||!u) return alert('Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
    const id = Date.now();
    db.ref(`content/${s}/${id}`).set({ type:t, title:ti, url:u, duration:d||'-', createdAt:new Date().toISOString() })
      .then(loadContent);
  }
  function loadContent() {
    document.getElementById('loader-con').style.display = 'block';
    const tbl = document.getElementById('tbl-con'), body = tbl.querySelector('tbody');
    body.innerHTML = '';
    db.ref('content').once('value').then(snap => {
      snap.forEach(stg => {
        stg.forEach(item => {
          const it = item.val();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.key}</td>
            <td>${stg.key}</td>
            <td>${it.type}</td>
            <td>${it.title}</td>
            <td><a href="${it.url}" target="_blank">Ø±Ø§Ø¨Ø·</a></td>
            <td>${it.duration}</td>
            <td>
              <button class="action delete-btn"
                onclick="db.ref('content/${stg.key}/${item.key}').remove().then(loadContent)">
                Ø­Ø°Ù
              </button>
            </td>`;
          body.appendChild(row);
        });
      });
    }).finally(()=>{
      document.getElementById('loader-con').style.display = 'none';
      tbl.style.display = 'table';
    });
  }

  // ==== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ====
  function addAnnouncement() {
    const s = document.getElementById('ann-stage').value;
    const txt = document.getElementById('ann-text').value.trim();
    if(!s||!txt) return alert('Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
    db.ref(`settings/announcements/${s}`).set({ text:txt, updatedAt:new Date().toISOString() })
      .then(loadAnnouncements);
  }
  function loadAnnouncements() {
    document.getElementById('loader-ann').style.display = 'block';
    const tbl = document.getElementById('tbl-ann'), body = tbl.querySelector('tbody');
    body.innerHTML = '';
    db.ref('settings/announcements').once('value').then(snap => {
      snap.forEach(p => {
        const v = p.val();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.key}</td>
          <td>${v.text}</td>
          <td>
            <button class="action delete-btn"
              onclick="db.ref('settings/announcements/${p.key}').remove().then(loadAnnouncements)">
              Ø­Ø°Ù
            </button>
          </td>`;
        body.appendChild(row);
      });
    }).finally(()=>{
      document.getElementById('loader-ann').style.display = 'none';
      tbl.style.display = 'table';
    });
  }

  // ==== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ====
  let chart;
  function loadStats() {
    db.ref('users/students').once('value').then(snap => {
      const cnts = { grade4:0,grade5:0,grade6:0,prep1:0,prep2:0,prep3:0 };
      Object.values(snap.val()||{}).forEach(u=>{
        if(cnts[u.stage]!=undefined) cnts[u.stage]++;
      });
      const ctx = document.getElementById('chartStages').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels:['Ø±Ø§Ø¨Ø¹','Ø®Ø§Ù…Ø³','Ø³Ø§Ø¯Ø³','1Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ','2Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ','3Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ'], datasets:[{ label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨', data:Object.values(cnts) }] }
      });
    });
  }

  // ==== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ====
showSection('students');

  function filterStudents() {
    const input = document.getElementById("student-search").value.trim().toLowerCase();
    const rows = document.querySelectorAll("#tbl-stu tbody tr");
    rows.forEach(row => {
      const phone = row.cells[0].innerText.toLowerCase();
      const name = row.cells[1].innerText.toLowerCase();
      row.style.display = (phone.includes(input) || name.includes(input)) ? "" : "none";
    });
  }
</script>
</script>
</body>
</html>

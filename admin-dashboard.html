<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة التحكم - منصة العلوم</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: #1e1e1e;
      color: #fff;
    }
    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); display: flex;
      align-items: center; justify-content: center; z-index: 1000;
    }
    .password-box {
      background: #fff; padding: 1.5rem; border-radius: 10px;
      width: 90%; max-width: 320px; text-align: center;
    }
    .password-box input {
      width: 100%; padding: 0.7rem; margin-top: 0.5rem;
      border: 1px solid #ccc; border-radius: 5px;
      font-size: 1rem;
    }
    .password-box button {
      margin-top: 1rem; padding: 0.7rem 1rem;
      background: #b6a564; color: #fff; border: none;
      border-radius: 5px; font-size: 1rem; cursor: pointer;
    }
    .password-box .error { color: red; margin-top: 0.6rem; }

    .topnav {
      display: flex; flex-wrap: wrap; justify-content: center;
      gap: 0.6rem; background: #24221e; color: #fff;
      padding: 0.7rem 0; font-size: 0.95rem;
    }
    .topnav div {
      cursor: pointer; padding: 0.4rem 1.2rem;
      border-radius: 20px; background: #b6a564; color: #fff;
      transition: 0.3s;
    }
    .topnav div.active { background: #3ab54a; }

    .main { padding: 1rem; max-width: 1000px; margin: auto; }
    section { display: none; margin-top: 1.5rem; }
    section.active { display: block; }
    
    /* التنسيقات الجديدة */
    .form-group { margin: 1rem 0; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.6rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    .loader {
      text-align: center;
      margin: 1rem 0;
      color: #999;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background-color: #b6a564;
      color: #fff;
    }
    .action {
      padding: 0.4rem 0.6rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      margin: 0 2px;
    }
    .active-btn { background: #3ab54a; color: white; }
    .inactive-btn { background: #e74c3c; color: white; }
    .delete-btn { background: #7f8c8d; color: white; }
    .chart-container {
      max-width: 600px;
      margin: 2rem auto;
    }
  </style>
</head>
<body>

<!-- شاشة كلمة السر -->
<div id="overlay" class="overlay">
  <div class="password-box">
    <h3>أدخل كلمة المرور</h3>
    <input type="password" id="admin-pass" placeholder="🔒 كلمة المرور" />
    <button onclick="checkPassword()">دخول</button>
    <div id="pass-error" class="error"></div>
  </div>
</div>

<!-- لوحة التحكم -->
<div id="dashboard" style="display:none;">
  <div class="topnav">
    <div id="tab-stu" class="active" onclick="showSection('students')">👥 الطلاب</div>
    <div id="tab-con" onclick="showSection('content')">📁 المحتوى</div>
    <div id="tab-ann" onclick="showSection('announce')">🔔 الإعلانات</div>
    <div id="tab-stat" onclick="showSection('stats')">📊 الإحصائيات</div>
  </div>
  
  <div class="main">
    <!-- قسم الطلاب -->
    <section id="students" class="active">
      <h2>قائمة الطلاب</h2>
      <div class="form-group">
        <input type="text" id="student-search" placeholder="🔍 ابحث بالاسم أو الهاتف" oninput="filterStudents()" />
      </div>
      <div id="loader-stu" class="loader">جاري التحميل…</div>
      <table id="tbl-stu" style="display:none;">
        <thead>
          <tr>
            <th>📞 الهاتف</th>
            <th>👤 الاسم</th>
            <th>🎓 المرحلة</th>
            <th>📍 المحافظة</th>
            <th>✅ مفعل؟</th>
            <th>🕓 التسجيل</th>
            <th>🛠️ الإجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- قسم المحتوى -->
    <section id="content">
      <h2>📁 إدارة المحتوى</h2>
      <div class="form-group">
        <label>المرحلة الدراسية</label>
        <select id="content-stage">
          <option value="">-- اختر المرحلة --</option>
          <option value="grade4">الصف الرابع</option>
          <option value="grade5">الصف الخامس</option>
          <option value="grade6">الصف السادس</option>
          <option value="prep1">الأول الإعدادي</option>
          <option value="prep2">الثاني الإعدادي</option>
          <option value="prep3">الثالث الإعدادي</option>
        </select>
      </div>
      <div class="form-group">
        <label>نوع المحتوى</label>
        <select id="content-type">
          <option value="video">🎥 فيديو</option>
          <option value="file">📄 ملف</option>
          <option value="quiz">📝 اختبار</option>
        </select>
      </div>
      <div class="form-group">
        <label>عنوان المحتوى</label>
        <input type="text" id="content-title" placeholder="أدخل عنوان واضح للمحتوى" />
      </div>
      <div class="form-group">
        <label>رابط المحتوى</label>
        <input type="text" id="content-url" placeholder="مثال: https://..." />
      </div>
      <div class="form-group">
        <label>⏱️ مدة الفيديو (اختياري)</label>
        <input type="text" id="content-duration" placeholder="مثال: 10:35" />
      </div>
      <button class="action active-btn" onclick="submitContent()">➕ إضافة</button>
      <div id="loader-con" class="loader">جاري تحميل المحتوى...</div>
      <table id="tbl-con" style="display:none;">
        <thead>
          <tr>
            <th>ID</th>
            <th>مرحلة</th>
            <th>نوع</th>
            <th>العنوان</th>
            <th>الرابط</th>
            <th>المدة</th>
            <th>❌ حذف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- قسم الإعلانات -->
    <section id="announce">
      <h2>🔔 إدارة الإعلانات</h2>
      <div class="form-group">
        <label>المرحلة المستهدفة</label>
        <select id="ann-stage">
          <option value="">-- اختر المرحلة --</option>
          <option value="grade4">الصف الرابع</option>
          <option value="grade5">الصف الخامس</option>
          <option value="grade6">الصف السادس</option>
          <option value="prep1">الأول الإعدادي</option>
          <option value="prep2">الثاني الإعدادي</option>
          <option value="prep3">الثالث الإعدادي</option>
        </select>
      </div>
      <div class="form-group">
        <label>نص الإعلان</label>
        <textarea id="ann-text" rows="3" placeholder="اكتب هنا نص الإعلان..."></textarea>
      </div>
      <button class="action active-btn" onclick="addAnnouncement()">➕ نشر</button>
      <div id="loader-ann" class="loader">⏳ جاري تحميل الإعلانات...</div>
      <table id="tbl-ann" style="display:none;">
        <thead>
          <tr>
            <th>المرحلة</th>
            <th>نص الإعلان</th>
            <th>🗑️ حذف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- قسم الإحصائيات -->
    <section id="stats">
      <h2>📊 إحصائيات المنصة</h2>
      <div class="chart-container">
        <canvas id="chartStages"></canvas>
      </div>
      <p>📌 إجمالي الطلاب: <span id="cntAll">0</span></p>
      <p>✅ مشتركون مفعلون: <span id="cntActive">0</span></p>
      <p>📆 طلاب جدد اليوم: <span id="cntToday">0</span></p>
      <p>💳 طلاب بانتظار التفعيل: <span id="cntPending">0</span></p>
    </section>
  </div>
</div>

<script>
  // ==== تهيئة Firebase ====
  const firebaseConfig = {
    apiKey: "AIzaSyDEvdGB2dHbB9k0mvAa14VFaKvjSfooB20",
    authDomain: "manssat-science.firebaseapp.com",
    databaseURL: "https://manssat-science-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "manssat-science",
    storageBucket: "manssat-science.appspot.com",
    messagingSenderId: "22539678455",
    appId: "1:22539678455:web:bd8cdc9ecd950a2b53d9f2"
  };
  
  // تهيئة التطبيق فقط إذا لم يتم تهيئته مسبقاً
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();

  // ==== كلمة المرور (يجب تغييرها في بيئة الإنتاج) ====
  const SECRET = "islamemad01122104596#";

  function checkPassword() {
    const pass = document.getElementById('admin-pass').value.trim();
    if (pass === SECRET) {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      showSection('students');
      loadStudents(); // تحميل الطلاب مباشرة بعد الدخول
    } else {
      document.getElementById('pass-error').innerText = 'كلمة المرور غير صحيحة.';
    }
  }

  function showSection(id) {
    const sections = ['students', 'content', 'announce', 'stats'];
    sections.forEach(sec => {
      const sectionEl = document.getElementById(sec);
      const tabEl = document.getElementById('tab-' + sec.slice(0,3));
      
      if (sectionEl) sectionEl.classList.toggle('active', sec === id);
      if (tabEl) tabEl.classList.toggle('active', sec === id);
    });
    
    // تحميل المحتوى عند التبديل للأقسام
    if (id === 'students') loadStudents();
    else if (id === 'content') loadContent();
    else if (id === 'announce') loadAnnouncements();
    else if (id === 'stats') loadStats();
  }

  // ==== إدارة الطلاب ====
  function loadStudents() {
    document.getElementById("loader-stu").style.display = "block";
    const table = document.getElementById("tbl-stu");
    const tbody = table.querySelector("tbody");
    tbody.innerHTML = "";

    db.ref("users/students").once("value").then(snapshot => {
      const data = snapshot.val() || {};
      Object.entries(data).forEach(([phone, student]) => {
        const isActive = student["اشتراك_مفعل"] === true;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${phone}</td>
          <td>${student["الاسم"] || "-"}</td>
          <td>${student["المرحلة"] || "-"}</td>
          <td>${student["المحافظة"] || "-"}</td>
          <td>${isActive ? "✅" : "❌"}</td>
          <td>${student["مسجل_في"] ? new Date(student["مسجل_في"]).toLocaleDateString('ar-EG') : "-"}</td>
          <td>
            <button class="action ${isActive ? 'inactive-btn' : 'active-btn'}"
              onclick="toggleActivation('${phone}', ${!isActive})">
              ${isActive ? 'إلغاء' : 'تفعيل'}
            </button>
            <button class="action delete-btn"
              onclick="if(confirm('هل تريد حذف هذا الطالب؟')) deleteStudent('${phone}')">
              حذف
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }).catch(error => {
      console.error("Error loading students:", error);
    }).finally(() => {
      document.getElementById("loader-stu").style.display = "none";
      table.style.display = "table";
    });
  }

  function toggleActivation(phone, newState) {
    db.ref(`users/students/${phone}/اشتراك_مفعل`).set(newState)
      .then(() => loadStudents());
  }

  function deleteStudent(phone) {
    db.ref(`users/students/${phone}`).remove()
      .then(() => loadStudents());
  }

  function filterStudents() {
    const query = document.getElementById("student-search").value.toLowerCase();
    const rows = document.querySelectorAll("#tbl-stu tbody tr");
    rows.forEach(row => {
      const phone = row.cells[0].innerText.toLowerCase();
      const name = row.cells[1].innerText.toLowerCase();
      row.style.display = (phone.includes(query) || name.includes(query)) ? "" : "none";
    });
  }

  // ==== إدارة المحتوى ====
  function submitContent() {
    const stage = document.getElementById("content-stage").value;
    const type = document.getElementById("content-type").value;
    const title = document.getElementById("content-title").value.trim();
    const url = document.getElementById("content-url").value.trim();
    const duration = document.getElementById("content-duration").value.trim() || "-";

    if (!stage || !type || !title || !url) {
      alert("من فضلك املأ كل الحقول المطلوبة.");
      return;
    }

    const id = Date.now();
    db.ref(`content/${stage}/${id}`).set({
      type: type,
      title: title,
      url: url,
      duration: duration,
      createdAt: new Date().toISOString()
    }).then(() => {
      document.getElementById("content-title").value = "";
      document.getElementById("content-url").value = "";
      document.getElementById("content-duration").value = "";
      loadContent();
    });
  }

  function loadContent() {
    document.getElementById("loader-con").style.display = "block";
    const table = document.getElementById("tbl-con");
    const tbody = table.querySelector("tbody");
    tbody.innerHTML = "";

    db.ref("content").once("value").then(snapshot => {
      snapshot.forEach(stageSnap => {
        const stage = stageSnap.key;
        stageSnap.forEach(itemSnap => {
          const item = itemSnap.val();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${itemSnap.key}</td>
            <td>${stage}</td>
            <td>${item.type}</td>
            <td>${item.title}</td>
            <td><a href="${item.url}" target="_blank">🔗 فتح</a></td>
            <td>${item.duration}</td>
            <td>
              <button class="action delete-btn" onclick="deleteContent('${stage}', '${itemSnap.key}')">حذف</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      });
    }).catch(error => {
      console.error("Error loading content:", error);
    }).finally(() => {
      document.getElementById("loader-con").style.display = "none";
      table.style.display = "table";
    });
  }

  function deleteContent(stage, id) {
    db.ref(`content/${stage}/${id}`).remove()
      .then(() => loadContent());
  }

  // ==== إدارة الإعلانات ====
  function addAnnouncement() {
    const stage = document.getElementById("ann-stage").value;
    const text = document.getElementById("ann-text").value.trim();

    if (!stage || !text) {
      alert("يرجى إدخال المرحلة ونص الإعلان.");
      return;
    }

    const data = {
      text: text,
      updatedAt: new Date().toISOString()
    };

    db.ref(`settings/announcements/${stage}`).set(data).then(() => {
      document.getElementById("ann-text").value = "";
      loadAnnouncements();
    });
  }

  function loadAnnouncements() {
    document.getElementById("loader-ann").style.display = "block";
    const table = document.getElementById("tbl-ann");
    const tbody = table.querySelector("tbody");
    tbody.innerHTML = "";

    db.ref("settings/announcements").once("value").then(snapshot => {
      snapshot.forEach(stageSnap => {
        const stage = stageSnap.key;
        const ann = stageSnap.val();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${stage}</td>
          <td>${ann.text}</td>
          <td>
            <button class="action delete-btn" onclick="deleteAnnouncement('${stage}')">حذف</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }).catch(error => {
      console.error("Error loading announcements:", error);
    }).finally(() => {
      document.getElementById("loader-ann").style.display = "none";
      table.style.display = "table";
    });
  }

  function deleteAnnouncement(stage) {
    db.ref(`settings/announcements/${stage}`).remove()
      .then(() => loadAnnouncements());
  }

  // ==== الإحصائيات ====
  let chart;

  function loadStats() {
    db.ref('users/students').once('value').then(snapshot => {
      const data = snapshot.val() || {};
      const counts = {
        grade4: 0,
        grade5: 0,
        grade6: 0,
        prep1: 0,
        prep2: 0,
        prep3: 0,
      };
      let total = 0;
      let active = 0;
      let today = 0;
      let pending = 0;
      
      const todayDate = new Date().toISOString().split('T')[0];

      Object.values(data).forEach(user => {
        total++;
        if (user["اشتراك_مفعل"]) active++;
        
        // طلاب جدد اليوم
        if (user["مسجل_في"] && user["مسجل_في"].includes(todayDate)) {
          today++;
        }
        
        // طلاب بانتظار التفعيل
        if (!user["اشتراك_مفعل"] && user["payment"]?.sent) {
          pending++;
        }
        
        // إحصائيات المراحل
        if (counts[user["المرحلة"]] !== undefined) {
          counts[user["المرحلة"]]++;
        }
      });

      document.getElementById("cntAll").innerText = total;
      document.getElementById("cntActive").innerText = active;
      document.getElementById("cntToday").innerText = today;
      document.getElementById("cntPending").innerText = pending;

      const ctx = document.getElementById("chartStages").getContext("2d");

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["رابع", "خامس", "سادس", "أولى إعدادى", "ثانية إعدادى", "ثالثة إعدادى"],
          datasets: [{
            label: "عدد الطلاب",
            data: Object.values(counts),
            backgroundColor: "#3ab54a",
            borderRadius: 5
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });

    }).catch(err => {
      console.error('Error loading statistics:', err);
    });
  }

  // ==== تهيئة الصفحة عند التحميل ====
  document.addEventListener('DOMContentLoaded', () => {
    // إخفاء جميع الأقسام باستثناء شاشة الدخول
    document.getElementById('dashboard').style.display = 'none';
  });
</script>
</body>
      </html>
